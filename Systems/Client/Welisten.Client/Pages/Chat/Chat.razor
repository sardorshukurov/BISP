@page "/chat"
@using Microsoft.AspNetCore.SignalR.Client

@inject NavigationManager NavManager;
@inject IJSRuntime JSRuntime;
@implements IAsyncDisposable;

<h3>Chat</h3>

@if (!IsConnected && !_isWaiting)
{
    <div class="input-group">
        <input @bind="_username" class="form-control" placeholder="What's your name?">
        <button class="btn btn-primary form-control-append" @onclick="Connect">
            Connect
        </button>
    </div>
}
else if (_isWaiting)
{
    <p>Waiting for other user to connect...</p>
}
else
{
    <textarea style="width: 100%; height: 500px;" @ref="TextAreaRef">
        @_messages
    </textarea>
    <div class="input-group">
        <input @bind-value="_message"
               @bind-value:event="oninput"
               @onkeyup="HandleInput"
               class="form-control">
        <button class="btn btn-primary form-group-append"
                @onclick="Send"
                disabled="@(!IsConnected)">
            Send
        </button>
        <button class="btn btn-secondary" @onclick="SwitchToAnotherSession" disabled="@(!IsConnected)">
            Switch to Another Session
        </button>
    </div>
}

@code {
    private HubConnection? _hubConnection;
    private string _messages = string.Empty;
    private string _username = string.Empty;
    private string _message = string.Empty;
    ElementReference TextAreaRef;
    private bool _isWaiting = false;

    private async Task Connect()
    {
        _isWaiting = true;
        _hubConnection = new HubConnectionBuilder()
            .WithUrl(Settings.ApiRoot + "/chathub")
            .Build();

        _hubConnection.On<string, string>("ReceiveMessage", (user, message) =>
        {
            var msg = $"{(string.IsNullOrEmpty(user) ? "" : user + ": ")} {message}";
            _messages += msg + "\n";
            JSRuntime.InvokeVoidAsync("scrollToBottom", TextAreaRef);
            StateHasChanged();
            // If the received message indicates that another user has connected, set _isWaiting to false
            if (message == "You are now connected! Start chatting.")
            {
                _isWaiting = false;
                StateHasChanged(); // Update the UI
            }
        });

        await _hubConnection.StartAsync();
        await _hubConnection.SendAsync("Connect", _username);
    }
    
    private async Task SwitchToAnotherSession()
    {
        // Disconnect the current user from the current session
        await Disconnect();

        // Reconnect the user to find another session
        await Connect();
    }
    
    private async Task Disconnect()
    {
        if (_hubConnection != null)
        {
            await _hubConnection.StopAsync();
            await DisposeAsync();
            _hubConnection = null;
        }
    }

    private async Task Send()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.SendAsync("SendMessage", $"{_username}: {_message}");
            _message = string.Empty;
        }
    }

    private async Task HandleInput(KeyboardEventArgs args)
    {
        if (args.Key is null || args.Key.Equals("Enter"))
        {
            await Send();
        }
    }

    public bool IsConnected => _hubConnection?.State == HubConnectionState.Connected;

    public async ValueTask DisposeAsync()
    {
        if (_hubConnection is not null)
        {
            await _hubConnection.DisposeAsync();
        }
    }
}
